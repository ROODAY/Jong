<!DOCTYPE html>
<html>
	<head>
		<title>Jong</title>
		<link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
		<meta name="msapplication-TileColor" content="#FFFFFF">
		<meta name="msapplication-TileImage" content="favicons/favicon-144.png">
		<meta name="msapplication-config" content="favicons/browserconfig.xml">
	
		<link rel="shortcut icon" href="favicons/favicon.ico">
		<link rel="icon" sizes="16x16 32x32 64x64" href="favicons/favicon.ico">
		<link rel="icon" type="image/png" sizes="196x196" href="favicons/favicon-196.png">
		<link rel="icon" type="image/png" sizes="160x160" href="favicons/favicon-160.png">
		<link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96.png">
		<link rel="icon" type="image/png" sizes="64x64" href="favicons/favicon-64.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16.png">
		<link rel="apple-touch-icon" sizes="152x152" href="favicons/favicon-152.png">
		<link rel="apple-touch-icon" sizes="144x144" href="favicons/favicon-144.png">
		<link rel="apple-touch-icon" sizes="120x120" href="favicons/favicon-120.png">
		<link rel="apple-touch-icon" sizes="114x114" href="favicons/favicon-114.png">
		<link rel="apple-touch-icon" sizes="76x76" href="favicons/favicon-76.png">
		<link rel="apple-touch-icon" sizes="72x72" href="favicons/favicon-72.png">
		<link rel="apple-touch-icon" href="favicons/favicon-57.png">

		<style>
			body {
				background-color: black;
				overflow: none;
				font-size: 1rem;
			}
			h1 {
				text-align: center;
				font-family: 'Audiowide', sans-serif;
				font-size: 3rem;
				color: #39FF14;
			}
			canvas {
			    padding-left: 0;
			    padding-right: 0;
			    margin-left: auto;
			    margin-right: auto;
			    display: block;
			    width: 800px;
			    height: 800px;
			}
		</style>
	</head>
	<body>
		<h1>Jong</h1>
		<canvas id="game"></canvas>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
			var canvas = document.getElementById("game");
			var context = canvas.getContext("2d");
			canvas.width = 800;
			canvas.height = 800;
			context.beginPath();
			var keysDown = {};
			var name;

			document.addEventListener('keydown', function(e){
				keysDown[e.keyCode] = true;
			},false);
			document.addEventListener('keyup', function(e){
				delete keysDown[e.keyCode];
			},false);

			socket.on('initIdentity', function(n){
				name = n;
			});
			console.log(name);


			Ball = function(x, y, dx, dy){
				this.x = x;
				this.y = y;
				this.dx = dx;
				this.dy = dy; 
			};
			Ball.prototype.update = function(delta) {
				if(this.x < 0){
					this.dx *= -1;
				}
				if(this.x + 50 > 800){
					this.dx *= -1;
				}
				if(this.y < 0){
					this.dy *= -1;
				}
				if(this.y + 50 > 800){
					this.dy *= -1;
				}
				
				// if(){this.dx *= -1;}
				// if(){this.dx *= -1;}

				// if(){this.dy *= -1;}
				// if(){this.dy *= -1;}

				this.x += this.dx * delta;
				this.y += this.dy * delta;
				if(name === "p1"){
					socket.emit('outgoingBallUpdate', this.x, this.y);
				}
			};
			Ball.prototype.draw = function(ctx) {
				ctx.beginPath();
				ctx.strokeStyle = "#39FF14";
				ctx.arc(this.x + 25, this.y + 25, 25, 0,2*Math.PI);
				ctx.stroke();
			};

			Paddle = function(x, y, name){
				this.x = x;
				this.y = y;
				this.name = name
			}
			Paddle.prototype.update = function(delta) {
				if(37 in keysDown){
					if(name === "p3"){
						this.x -= 200 * delta;
					}
					if(name === "p4"){
						this.x -= 200 * delta;
					}
				};//left
				if(38 in keysDown){
					if(name === "p1"){
						this.y -= 200 * delta;
					}
					if(name === "p2"){
						this.y -= 200 * delta;
					}
				};//up
				if(39 in keysDown){
					if(name === "p3"){
						this.x += 200 * delta;
					}
					if(name === "p4"){
						this.x += 200 * delta;
					}
				};//right
				if(40 in keysDown){
					if(name === "p1"){
						this.y += 200 * delta;
					}
					if(name === "p2"){
						this.y += 200 * delta;
					}
				};//down
				if(this.x > 800){
					this.x = -100;
				}
				if(this.x < -100){
					this.x = 800;
				}
				if(this.y > 800){
					this.y = -100;
				}
				if(this.y < -100){
					this.y = 800;
				}
				if(this.name === "paddle1"){
					socket.emit('outgoingPaddle1Update', this.x, this.y);
				}else if(this.name === "paddle2"){
					socket.emit('outgoingPaddle2Update', this.x, this.y);
				}else if(this.name === "paddle3"){
					socket.emit('outgoingPaddle3Update', this.x, this.y);
				}else if(this.name === "paddle4"){
					socket.emit('outgoingPaddle4Update', this.x, this.y);
				}
			};
			Paddle.prototype.draw = function(ctx) {
				ctx.beginPath();
				ctx.fillStyle="#39FF14";
				if(this.name === "paddle1" || this.name === "paddle2"){
					ctx.fillRect(this.x, this.y, 20, 100);
				}else if(this.name === "paddle3" || this.name === "paddle4"){
					ctx.fillRect(this.x, this.y, 100, 20);
				}
			};

			var ball = new Ball(400,400,-300,300);
			var paddle1 = new Paddle(40, (canvas.height/2)-40, "paddle1");
			var paddle2 = new Paddle(canvas.width - 80, (canvas.height/2)-40, "paddle2");
			var paddle3 = new Paddle((canvas.width/2)-40, 40, "paddle3");
			var paddle4 = new Paddle((canvas.width/2)-40, canvas.height-80, "paddle4");

			socket.on('incomingBallUpdate', function(x, y){
				if(!(name === "p1")){
					ball.x = x;
					ball.y = y;
				}
			});
			socket.on('incomingPaddle1Update', function(x,y){
				if(!(name === "p1")){
					paddle1.x = x;
					paddle1.y = y;
				}
			});
			socket.on('incomingPaddle2Update', function(x,y){
				if(!(name === "p2")){
					paddle2.x = x;
					paddle2.y = y;
				}
			});
			socket.on('incomingPaddle3Update', function(x,y){
				if(!(name === "p3")){
					paddle3.x = x;
					paddle3.y = y;
				}
			});
			socket.on('incomingPaddle4Update', function(x,y){
				if(!(name === "p4")){
					paddle4.x = x;
					paddle4.y = y;
				}
			});

			var main = function(){
				var now = Date.now();
				var delta = now - then;

				update(delta/1000);
				render();

				then = now;
				requestAnimationFrame(main);
			};
			var update = function(delta){
				ball.update(delta);
				if(name === "p1"){
					paddle1.update(delta);
				}
				if(name === "p2"){
					paddle2.update(delta);
				}
				if(name === "p3"){
					paddle3.update(delta);
				}
				if(name === "p4"){
					paddle4.update(delta);
				}

			};
			var render = function(){
				context.beginPath();
				context.fillStyle="black";
				context.fillRect(0,0,canvas.width,canvas.height);

				ball.draw(context);
				paddle1.draw(context);
				paddle2.draw(context);
				paddle3.draw(context);
				paddle4.draw(context);
			};

			then = Date.now();
			main();
		</script>
	</body>
</html>